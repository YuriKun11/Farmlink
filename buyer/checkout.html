<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">

    
<!-- Navbar -->
<header class="bg-white shadow-md py-4 px-6 sm:px-10">
    <div class="max-w-screen-xl mx-auto flex items-center justify-between">
      <!-- Logo -->
      <span class="text-green-500 font-bold text-2xl sm:text-3xl">FarmLink</span>
    </div>
  </header>

  <!-- End of Navbar -->
    <div class="max-w-screen-md mx-auto p-6">
      
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="overflow-x-auto">
             
                <!-- fetch table -->
                <table id="cart-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>

            <div class="mt-6 flex justify-between">
                <!-- return to shop button -->
                <button  onclick="window.location.href='farmlink.html'" class="bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-100 focus:outline-none">
                    Return To Shop
                </button>
                <!-- update cart button -->
                <button id="update-cart" class="bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-100 focus:outline-none">
                    Update Cart
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mt-8 w-full sm:w-auto self-end">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Cart Total</h2>
            <div class="flex justify-between mb-2">
                <span class="text-gray-700">Subtotal:</span>
                <span class="font-semibold text-gray-800" id="subtotal-amount">₱390</span>
            </div>
            <div class="flex justify-between mb-4">
                <span class="text-gray-700">Shipping:</span>
                <span class="font-semibold text-gray-800">₱50</span>
            </div>
            <div class="border-t border-gray-200 py-2 flex justify-between mb-4">
                <span class="text-gray-700 font-semibold">Total:</span>
                <span class="font-bold text-gray-900" id="total-amount">₱440</span>
            </div>
            <button onclick="showReviewModal()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-md w-full focus:outline-none">
                Process to checkout
            </button>
        </div>
    </div>

    <!-- REVIEW MODAL PARA MAGANDA -->
    <div id="review-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-lg">
          <h2 class="text-xl font-bold mb-4 text-gray-800">Review Your Order</h2>
      
          <!-- Item List -->
          <div id="review-items" class="space-y-4 max-h-60 overflow-y-auto border-b border-gray-200 pb-4 mb-4">
            <!-- Filled dynamically -->
          </div>
      
          <!-- Totals -->
          <div class="text-sm text-gray-800 space-y-2">
            <div class="flex justify-between">
              <span>Subtotal:</span>
              <span id="review-subtotal">₱0.00</span>
            </div>
            <div class="flex justify-between">
              <span>Shipping:</span>
              <span>₱50.00</span>
            </div>
            <div class="flex justify-between font-semibold border-t pt-2">
              <span>Total:</span>
              <span id="review-total">₱0.00</span>
            </div>
          </div>
      
          <!-- Buttons -->
          <div class="flex justify-between mt-6">
            <button onclick="closeReviewModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
            <button onclick="proceedToCheckout()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Proceed</button>
          </div>
        </div>
      </div>
  <!-- Toast message -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg opacity-0 transform transition-opacity duration-300">
        Product quantity updated!
    </div>

    <script>

function showReviewModal() {
    const modal = document.getElementById('review-modal');
    const reviewItems = document.getElementById('review-items');
    const subtotalDisplay = document.getElementById('review-subtotal');
    const totalDisplay = document.getElementById('review-total');

    reviewItems.innerHTML = '';
    let subtotal = 0;

    const rows = document.querySelectorAll('#cart-table tbody tr');
    rows.forEach(row => {
        const name = row.querySelector('td:nth-child(1) .text-sm').textContent;
        const quantity = row.querySelector('input[type="number"]').value;
        const subtotalText = row.querySelector('td:nth-child(4)').textContent.trim();

        const numericSubtotal = parseFloat(subtotalText.replace(/[^\d.]/g, '')) || 0;
        subtotal += numericSubtotal;

        const item = document.createElement('div');
        item.classList.add('flex', 'justify-between', 'items-center', 'text-sm', 'text-gray-700');
        item.innerHTML = `<span>${name} (x${quantity})</span><span>₱${numericSubtotal.toFixed(2)}</span>`;
        reviewItems.appendChild(item);
    });

    const shipping = 50;
    const total = subtotal + shipping;

    subtotalDisplay.textContent = `₱${subtotal.toFixed(2)}`;
    totalDisplay.textContent = `₱${total.toFixed(2)}`;

    modal.classList.remove('hidden');
}

function closeReviewModal() {
    document.getElementById('review-modal').classList.add('hidden');
}

function proceedToCheckout() {
    window.location.href = 'process.html';
}

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('update-cart')?.addEventListener('click', updateCartQuantities);
        });
    
        function updateCartQuantities() {
            const quantityInputs = document.querySelectorAll('input[type="number"][data-cart-id]');
            const updates = [];
    
            quantityInputs.forEach(input => {
                const cartId = input.getAttribute('data-cart-id');
                const quantity = parseInt(input.value);
    
                if (!isNaN(quantity) && quantity > 0) {
                    updates.push({ cart_id: cartId, quantity: quantity });
                }
            });
    
            fetch('../backend/update_cart_quantity.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ updates: updates })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    fetchCart();
                    showToast(); 
                } else {
                    alert('Failed to update cart.');
                }
            })
            .catch(err => console.error('Update error:', err));
        }
    
        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');
    
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 2000);
        }
    
        window.onload = function() {
            fetchCart();
        };
    
        function fetchCart() {
            fetch('../backend/get_cart.php')
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        displayCartItems(data.cart_items);
                    } else {
                        console.error('Failed to fetch cart:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching cart:', error);
                });
        }
    
        function displayCartItems(cartItems) {
            const cartTableBody = document.getElementById('cart-table').getElementsByTagName('tbody')[0];
            cartTableBody.innerHTML = '';
            let totalAmount = 0;
    
            cartItems.forEach(item => {
                const row = document.createElement('tr');
                row.classList.add('bg-white', 'divide-y', 'divide-gray-200');
    
                const productCell = document.createElement('td');
                productCell.classList.add('px-6', 'py-4', 'whitespace-nowrap');
    
                const productWrapper = document.createElement('div');
                productWrapper.classList.add('flex', 'items-center');
    
                const imageWrapper = document.createElement('div');
                imageWrapper.classList.add('h-10', 'w-10', 'flex-shrink-0');
    
                const img = document.createElement('img');
                img.src = `../backend/${item.image_url}`;
                img.alt = item.title;
                img.classList.add('h-10', 'w-10', 'rounded');
                imageWrapper.appendChild(img);
    
                const nameWrapper = document.createElement('div');
                nameWrapper.classList.add('ml-4');
    
                const name = document.createElement('div');
                name.classList.add('text-sm', 'font-medium', 'text-gray-900');
                name.textContent = item.title;
    
                nameWrapper.appendChild(name);
                productWrapper.appendChild(imageWrapper);
                productWrapper.appendChild(nameWrapper);
                productCell.appendChild(productWrapper);
    
                const priceCell = document.createElement('td');
                priceCell.classList.add('px-6', 'py-4', 'whitespace-nowrap');
                const priceText = document.createElement('div');
                priceText.classList.add('text-sm', 'text-gray-900');
                priceText.textContent = `₱${parseFloat(item.price).toFixed(2)}`;
                priceCell.appendChild(priceText);
    
                const quantityCell = document.createElement('td');
                quantityCell.classList.add('px-6', 'py-4', 'whitespace-nowrap');
                const quantityWrapper = document.createElement('div');
                quantityWrapper.classList.add('flex', 'items-center');
    
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.value = item.quantity;
                quantityInput.setAttribute('data-cart-id', item.cart_id);
                quantityInput.classList.add('w-16', 'text-center', 'border', 'border-gray-300', 'rounded-md', 'focus:outline-none', 'focus:ring-green-500', 'focus:border-green-500', 'text-gray-700', 'text-sm');
    
                quantityWrapper.appendChild(quantityInput);
                quantityCell.appendChild(quantityWrapper);
    
                const subtotalCell = document.createElement('td');
                subtotalCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-right');
                const subtotal = parseFloat(item.total_price).toFixed(2);
                const subtotalText = document.createElement('div');
                subtotalText.classList.add('text-sm', 'text-gray-900');
                subtotalText.textContent = `₱${subtotal}`;
                subtotalCell.appendChild(subtotalText);
    
                row.appendChild(productCell);
                row.appendChild(priceCell);
                row.appendChild(quantityCell);
                row.appendChild(subtotalCell);
    
                cartTableBody.appendChild(row);
    
                totalAmount += parseFloat(item.total_price);
            });
    
            const shipping = 50;
            const subtotalAmount = totalAmount;
            const totalAmountFinal = subtotalAmount + shipping;
    
            const subtotalElement = document.getElementById('subtotal-amount');
            const totalElement = document.getElementById('total-amount');
    
            if (subtotalElement) {
                subtotalElement.textContent = `₱${subtotalAmount.toFixed(2)}`;
            }
            if (totalElement) {
                totalElement.textContent = `₱${totalAmountFinal.toFixed(2)}`;
            }
        }
    </script>
    
    <script>
        function proceedToCheckout() {
            console.log("Okay");
    fetch('../backend/confirm_order.php')
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Order placed successfully!');
                window.location.href = 'process.html'; 
            } else {
                alert(data.message);
            }
        })
        .catch(err => {
            console.error('Checkout error:', err);
            alert('An error occurred while processing your order.');
        });
}
    </script>
    

</body>
</html>